<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Planner â€” Agenda interactif</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#667085; --accent:#0b74de;
      --grid:#e5e7eb; --good:#ff0000; --mid:#ffcc00; --low:#ffffff;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:var(--bg);color:var(--ink);margin:0;}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{font-size:20px;margin:4px 0 12px}
    .lead{color:var(--muted);font-size:14px;margin-bottom:14px}

    .card{background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(16,24,40,.06);padding:14px;margin-bottom:14px}
    label{font-size:12px;color:#374151}
    input,select,button{border:1px solid #d1d5db;border-radius:10px;padding:9px 10px;font-size:14px}
    input,select{width:100%;}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .btn{background:var(--accent);border:none;color:#fff;cursor:pointer}
    .btn.secondary{background:#475467}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .suggest{position:relative}
    .suggest-list{position:absolute;z-index:20;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;max-height:240px;overflow-y:auto}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f3f4f6}

    .summary{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:#eef2ff;color:#3730a3;border-radius:999px;padding:6px 10px;font-size:12px}

    .agenda{display:grid;grid-template-columns:120px repeat(7,1fr);border:1px solid var(--grid);border-radius:12px;overflow:hidden}
    .head{background:#f9fafb;font-weight:600}
    .cell,.head{border-bottom:1px solid var(--grid);border-right:1px solid var(--grid);padding:8px;text-align:center;font-size:12px}
    .hour{background:#fafafa}
    .cell{cursor:pointer;user-select:none;transition:transform .05s ease}
    .cell:hover{outline:2px solid rgba(11,116,222,.25);transform:scale(1.02)}
    .topBadge{font-size:11px;font-weight:700;background:#111;color:#fff;border-radius:6px;padding:2px 6px;display:inline-block}

    .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}
    .box{width:18px;height:12px;border:1px solid #d1d5db;border-radius:3px}

    dialog{border:none;border-radius:12px;box-shadow:0 24px 56px rgba(16,24,40,.2);padding:16px;max-width:360px}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    .modal-title{font-weight:700;margin:0 0 6px}
    .modal-meta{color:var(--muted);font-size:12px;margin-bottom:10px}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Solar Planner â€” Agenda interactif</h1>
    <p class="lead">Planifie facilement le lancement de tes appareils gourmands pendant les heures de plus forte production solaire.</p>

    <div class="card">
      <div class="row">
        <div class="col suggest">
          <label for="address">Adresse (avec suggestions)</label>
          <input id="address" type="text" placeholder="Ex. 89 Rue de la BruyÃ¨re, Rixensart" autocomplete="off" />
          <div id="suggest" class="suggest-list" style="display:none"></div>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="btnGeo" class="btn secondary" title="Utiliser ma localisation">Ma position</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="kwp">Puissance installÃ©e (kWp)</label>
          <input id="kwp" type="number" step="0.1" value="3.3">
        </div>
        <div class="col">
          <label for="threshold">Seuil d'affichage (kW, moyenne par heure)</label>
          <input id="threshold" type="number" step="0.1" value="0.7">
        </div>
        <div class="col">
          <label for="tz">Fuseau horaire</label>
          <input id="tz" type="text" value="Europe/Brussels">
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="btnRun" class="btn">Charger l'agenda</button>
        </div>
      </div>
      <div id="meta" class="muted" style="margin-top:6px"></div>
    </div>

    <div id="summary" class="card" style="display:none">
      <div class="summary" id="summaryChips"></div>
      <div class="legend" style="margin-top:10px">
        <span>LÃ©gende:</span>
        <span class="box" style="background:#ffffff"></span> trÃ¨s faible
        <span class="box" style="background:#ffe680"></span> moyen
        <span class="box" style="background:#ff0000"></span> trÃ¨s fort
        <span class="chip">ðŸ”¥ Top 10</span>
      </div>
    </div>

    <div id="agendaWrap" class="card" style="display:none">
      <div id="agenda" class="agenda"></div>
    </div>

    <dialog id="modal">
      <h3 class="modal-title" id="mTitle">DÃ©tail</h3>
      <div class="modal-meta" id="mMeta"></div>
      <div id="mBody"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnClose" class="btn secondary">Fermer</button>
      </div>
    </dialog>

    <div class="card">
      <strong>Conseils d'usage rapides</strong>
      <ul class="muted">
        <li>SÃ¨cheâ€‘linge / Four cÃ©ramique : privilÃ©gie des blocs continus de 2â€“4 h en orange/rouge.</li>
        <li>Recharge voiture : cible les aprÃ¨sâ€‘midi les plus rouges (puissance moyenne soutenue).</li>
        <li>Laveâ€‘vaisselle : une seule case rouge/orange suffit souvent.</li>
      </ul>
    </div>
  </div>

  <script>
    // ===== Utils =====
    const DAYS_FR = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
    const MONTHS_FR = ['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];

    const H_START = 6, H_END = 21; // Heures affichÃ©es (inclusives)

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function formatDayLabel(dateStr){
      const d = new Date(dateStr);
      return `${DAYS_FR[d.getDay()]} ${d.getDate()} ${MONTHS_FR[d.getMonth()]}`;
    }

    function hourLabel(h){
      return String(h).padStart(2,'0') + ':00';
    }

    function lerp(a,b,t){return a + (b-a)*t}
    // Couleur entre blanc -> jaune -> rouge selon ratio 0..1
    function colorForRatio(r){
      if (!isFinite(r) || r<=0) return 'rgb(255,255,255)';
      const mid = 0.6; // jusqu'Ã  0.6: blanc->jaune, aprÃ¨s: jaune->rouge
      if (r < mid){
        const t = r/mid; // 0..1
        const rC = Math.round(lerp(255,255,t));
        const gC = Math.round(lerp(255,230,t));
        const bC = Math.round(lerp(255,128,t));
        return `rgb(${rC},${gC},${bC})`; // blanc -> jaune pÃ¢le
      } else {
        const t = (r - mid)/(1-mid);
        const rC = Math.round(lerp(255,255,t));
        const gC = Math.round(lerp(230,0,t));
        const bC = Math.round(lerp(128,0,t));
        return `rgb(${rC},${gC},${bC})`; // jaune -> rouge
      }
    }

    function debounce(fn, delay=300){
      let to;return (...args)=>{clearTimeout(to);to=setTimeout(()=>fn(...args),delay)}
    }

    // ===== Address autocomplete (Nominatim) =====
    const addressInput = $('#address');
    const suggestBox = $('#suggest');

    addressInput.addEventListener('input', debounce(async ()=>{
      const q = addressInput.value.trim();
      if(q.length < 3){ suggestBox.style.display='none'; return; }
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&q=${encodeURIComponent(q)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(!Array.isArray(data) || data.length===0){ suggestBox.style.display='none'; return; }
        suggestBox.innerHTML = data.map(d=>`<div class="suggest-item" data-lat="${d.lat}" data-lon="${d.lon}">${d.display_name}</div>`).join('');
        suggestBox.style.display='block';
      }catch(e){ suggestBox.style.display='none'; }
    }, 350));

    suggestBox.addEventListener('click',(e)=>{
      const item = e.target.closest('.suggest-item');
      if(!item) return;
      addressInput.value = item.textContent;
      suggestBox.style.display='none';
      selectedLat = parseFloat(item.dataset.lat);
      selectedLon = parseFloat(item.dataset.lon);
      $('#meta').textContent = `CoordonnÃ©es: ${selectedLat.toFixed(5)}, ${selectedLon.toFixed(5)}`;
    });

    document.addEventListener('click',(e)=>{
      if(!suggestBox.contains(e.target) && e.target!==addressInput){suggestBox.style.display='none'}
    })

    // ===== Geolocation =====
    let selectedLat = null, selectedLon = null;
    $('#btnGeo').addEventListener('click',()=>{
      if(!navigator.geolocation){alert('GÃ©olocalisation non supportÃ©e');return}
      navigator.geolocation.getCurrentPosition(pos=>{
        selectedLat = pos.coords.latitude;
        selectedLon = pos.coords.longitude;
        $('#meta').textContent = `CoordonnÃ©es (ma position): ${selectedLat.toFixed(5)}, ${selectedLon.toFixed(5)}`;
      }, err=> alert('Erreur gÃ©oloc: '+err.message));
    });

    // ===== Open-Meteo fetch =====
    async function fetchOpenMeteo(lat, lon, tz){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&hourly=shortwave_radiation&timezone=${encodeURIComponent(tz)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    // ===== Build Agenda =====
    function computeAgenda(data, kwp, thresholdKw){
      const times = data.hourly.time; // ISO strings in tz
      const rad = data.hourly.shortwave_radiation; // W/mÂ² approximated as W

      // Build map day->hour->production(kW average)
      const dayMap = new Map(); // key: yyyy-mm-dd -> { label, hours: Map(h->prodKw) }
      let maxKw = 0;
      const allSlots = []; // for top10

      for(let i=0;i<times.length;i++){
        const iso = times[i];
        const [day, hms] = iso.split('T');
        const hour = parseInt(hms.slice(0,2),10);
        if(hour < H_START || hour > H_END) continue; // daylight window
        const prodKw = (rad[i]/1000) * kwp; // kW â‰ˆ (W/mÂ² / 1000) * kWp
        if(!dayMap.has(day)) dayMap.set(day,{label:formatDayLabel(day), hours:new Map()});
        dayMap.get(day).hours.set(hour, prodKw);
        if(prodKw > maxKw) maxKw = prodKw;
        allSlots.push({day, hour, prodKw});
      }

      // Determine top 10 hours overall
      const top10 = allSlots.sort((a,b)=>b.prodKw-a.prodKw).slice(0,10);
      const topKey = new Set(top10.map(s=>`${s.day}|${s.hour}`));

      return { dayMap, maxKw, topKey };
    }

    function renderAgenda(dayMap, maxKw, topKey, thresholdKw){
      const agenda = $('#agenda');
      agenda.innerHTML='';

      const days = Array.from(dayMap.keys()).sort();
      if(days.length===0){ agenda.innerHTML = '<div class="muted" style="padding:10px">Aucune donnÃ©e disponible.</div>'; return; }

      // Header row
      const headHour = document.createElement('div'); headHour.className='head cell'; headHour.textContent='Heure'; agenda.appendChild(headHour);
      days.forEach(d=>{ const el=document.createElement('div'); el.className='head cell'; el.textContent=dayMap.get(d).label; agenda.appendChild(el); });

      // Rows per hour
      for(let h=H_START; h<=H_END; h++){
        const hourLbl = document.createElement('div'); hourLbl.className='cell hour'; hourLbl.textContent=hourLabel(h); agenda.appendChild(hourLbl);
        days.forEach(d=>{
          const prodKw = dayMap.get(d).hours.get(h) || 0;
          const ratio = maxKw>0 ? Math.min(prodKw/maxKw,1) : 0;
          const bg = colorForRatio(ratio);
          const cell = document.createElement('div');
          cell.className='cell';
          cell.style.background = bg;
          cell.dataset.day = d;
          cell.dataset.hour = h;
          cell.dataset.prod = prodKw.toFixed(2);
          cell.title = `${formatDayLabel(d)} ${hourLabel(h)} â€” ~${prodKw.toFixed(2)} kW`;

          // Make weak cells white to deâ€‘clutter
          if(prodKw < thresholdKw*0.5){ cell.style.background = '#ffffff'; }

          // Top 10 badge
          if(topKey.has(`${d}|${h}`)){
            const b = document.createElement('div');
            b.className='topBadge'; b.textContent='ðŸ”¥ Top';
            b.style.position='absolute'; b.style.transform='translate(-6px,-6px)';
            cell.style.position='relative';
            cell.appendChild(b);
          }

          cell.addEventListener('click',()=>openModal(d,h,prodKw));
          agenda.appendChild(cell);
        });
      }

      $('#agendaWrap').style.display='block';
    }

    function renderSummary(topKey, dayMap){
      const chips = $('#summaryChips'); chips.innerHTML='';
      // Build a sorted list from topKey (we don't have values here, keep compact)
      const items = Array.from(topKey).map(k=>{
        const [d,h] = k.split('|');
        return {d, h:parseInt(h,10)};
      }).sort((a,b)=> (a.d===b.d ? a.h-b.h : a.d.localeCompare(b.d)));

      items.slice(0,3).forEach(it=>{
        const chip = document.createElement('span');
        chip.className='chip';
        chip.textContent = `${dayMap.get(it.d).label} ${hourLabel(it.h)}`;
        chips.appendChild(chip);
      });
      $('#summary').style.display='block';
    }

    // ===== Modal =====
    const modal = $('#modal');
    function openModal(day,hour,prodKw){
      $('#mTitle').textContent = `${formatDayLabel(day)} â€¢ ${hourLabel(hour)}`;
      $('#mMeta').textContent = `Production estimÃ©e ~ ${prodKw.toFixed(2)} kW (moyenne horaire)`;

      let suggestion = 'CrÃ©neau correct pour des appareils moyens (laveâ€‘vaisselle).';
      if(prodKw >= 2.0) suggestion = 'Excellent pour appareils trÃ¨s gourmands (voiture, four cÃ©ramique).';
      else if(prodKw >= 1.2) suggestion = 'Bon pour sÃ¨cheâ€‘linge et gros appareils pendant 1â€“2 h.';

      $('#mBody').innerHTML = `<div class="muted">Conseil: ${suggestion}</div>`;
      modal.showModal();
    }
    $('#btnClose').addEventListener('click',()=>modal.close());

    // ===== Run pipeline =====
    $('#btnRun').addEventListener('click', async ()=>{
      try{
        const tz = $('#tz').value || 'Europe/Brussels';
        const kwp = parseFloat($('#kwp').value) || 3.3;
        const thresholdKw = parseFloat($('#threshold').value) || 0.7;

        let lat = selectedLat, lon = selectedLon;
        if(lat==null || lon==null){
          // fallback: geocode current address text once
          const q = addressInput.value.trim();
          if(!q){ alert('Entrez une adresse ou utilisez Ma position.'); return; }
          const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
          const res = await fetch(url); const data = await res.json();
          if(!data.length){ alert('Adresse introuvable'); return; }
          lat = parseFloat(data[0].lat); lon = parseFloat(data[0].lon);
        }

        $('#meta').textContent = `CoordonnÃ©es utilisÃ©es: ${lat.toFixed(5)}, ${lon.toFixed(5)} â€¢ kWp: ${kwp} â€¢ Seuil: ${thresholdKw} kW`;

        const meteo = await fetchOpenMeteo(lat, lon, tz);
        const { dayMap, maxKw, topKey } = computeAgenda(meteo, kwp, thresholdKw);

        renderAgenda(dayMap, maxKw, topKey, thresholdKw);
        renderSummary(topKey, dayMap);
      }catch(e){
        alert('Erreur: '+e.message);
        console.error(e);
      }
    });
  </script>
</body>
</html>

